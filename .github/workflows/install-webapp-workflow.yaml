on: [workflow_dispatch]
name: Azure ARM
env:
  APP_NAME: feweb-7cu6grksc6oi6
  DB_NAME: coreDb
  SERVER_NAME: sqlserver7cu6grksc6oi6
jobs:
  build-and-deploy:
    runs-on: simpleLinuxVM
    steps:

      # Checkout code
    - uses: actions/checkout@main
    - name: login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: install app and db schema
      run: |
        az configure --defaults group={{ secrets.AZURE_RG }}

        cd msdocs-app-service-sqldb-dotnetcore
  
        remote_url=$(az webapp deployment list-publishing-credentials --name {{env.APP_NAME}}) --query scmUri -o tsv)
        remote_url_final=echo $remote_url | sed 's|//\$|//\\$|'
        git remote add azure $remote_url_final
        git push azure main:master

        connection_string=$(az sql db show-connection-string --client ado.net --name {{env.DB_NAME}} --server {{env.SERVER_NAME}})
        re_connection_string=$(echo $connection_string | sed -e 's/<username>/${{secrets.SQL_DB_ADMIN_NAME}}/' -e 's/<password>/${{secrets.SQL_DB_PASSWORD}}/')
        az webapp config connection-string set --connection-string-type SQLServer -n {{env.APP_NAME}} --settings MyDbConnection="$re_connection_string"
        
        cd DotNetCoreSqlDb
        MyDbConnection='Server=tcp:{{env.SERVER_NAME}}.database.windows.net,1433;Initial Catalog=coreDb;Persist Security Info=False;User ID=${{secrets.SQL_DB_ADMIN_NAME}};Password=${{secrets.SQL_DB_PASSWORD}};Encrypt=True;TrustServerCertificate=False;'
        tmp=$(mktemp)
        jq --arg a "$MyDbConnection" '.ConnectionStrings.MyDbConnection = $a' appsettings.json > "$tmp" && mv "$tmp" appsettings.json

        dotnet ef migrations add InitialCreate
        dotnet ef database update
